using RDPClient.Proxy;
using System;
using System.Collections.Generic;
using System.IO;
using System.IO.Compression;
using System.Linq;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading;

namespace RDPClientTest
{
    class Program
    {
		static void Main(string[] args)
		{
			for (; ; )
			{
				int count = Environment.ProcessorCount * 250;
				Response response = Program.GetServerInfos(count);
				if (response != null)
				{
					if (response.ServerInfos != null && response.ServerInfos.Any<ServerInfo>())
					{
						string output = "";
						foreach (ServerInfo si in response.ServerInfos)
                        {
							output += "{ \"create\" : { \"_index\" : \"test_serverinfo\", \"_type\" : \"_doc\"} }" + Environment.NewLine;
							string server = "{ \"Type\" : \"" + response.MethodProxyType + "\", \"ServerIp\" : \"" + si.ServerIp.ToString() + "\", \"ServerPort\" : \"" + si.ServerPort.ToString() + "\",\"Username\" : \"" + si.Username + "\",\"Password\" : \"" + si.Password + "\"}" + Environment.NewLine;
							output += server + Environment.NewLine;
						}
						ServerRequest(output);
					}
					if (response.ProxyInfos != null && response.ProxyInfos.Any<ProxyInfo>())
					{
						string output = "";
						foreach (ProxyInfo pi in response.ProxyInfos)
						{
							output += "{ \"create\" : { \"_index\" : \"proxyinfo\", \"_type\" : \"_doc\"} }" + Environment.NewLine;
							string server = "{ \"Type\" : \"" + response.MethodProxyType + "\", \"ServerIp\" : \"" + pi.Server.ToString() + "\", \"ServerPort\" : \"" + pi.Port.ToString() + "\", \"ProxyType\" : \"" + pi.Type.ToString() + "\", \"Username\" : \"" + pi.User + "\",\"Password\" : \"" + pi.Pass + "\"}" + Environment.NewLine;
							output += server + Environment.NewLine;
						}
						ServerRequest(output);
					}
				}
				Thread.Sleep(30000);
			}
		}

		static void ServerRequest(string request)
		{
			try
			{
				//string url = "http://10.0.0.6:9200";
				string url = "http://192.168.56.104:9200";
				string path = "/test_serverinfo/_bulk";
				string pipeline = "?pipeline=serverinfo_pipeline";
				var httpWebRequest = (HttpWebRequest)WebRequest.Create(url + path + pipeline);
				httpWebRequest.ContentType = "application/json";
				httpWebRequest.Method = "POST";
				using (var streamWriter = new StreamWriter(httpWebRequest.GetRequestStream()))
				{
					streamWriter.Write(request);
				}

				var httpResponse = (HttpWebResponse)httpWebRequest.GetResponse();
				using (var streamReader = new StreamReader(httpResponse.GetResponseStream()))
				{
					var result = streamReader.ReadToEnd();
					Console.WriteLine(result);
				}
			}
            catch { }
		}
		private static Response GetServerInfos(int count)
		{
			string text = Program.SendAndReceiveFromServer(JSONSerializer<Request>.Serialize(new Request
			{
				Type = "getlist",
				Value = count.ToString()
			}));
			if (text != "")
			{
				Console.WriteLine(text);
				return JSONSerializer<Response>.DeSerialize(text);
			}
			return null;
		}

		private static string SendAndReceiveFromServer(string data)
		{
			string result = "";
			Socket socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
			try
			{
				socket.Connect("149.202.10.237", 4500);
				byte[] array = Encoding.UTF8.GetBytes(data);
				byte[] array2 = BitConverter.GetBytes(array.Length);
				if (Program.Send(socket, array2) && Program.Send(socket, array))
				{
					array2 = new byte[4];
					if (Program.Receive(socket, array2))
					{
						array = new byte[BitConverter.ToInt32(array2, 0)];
						if (Program.Receive(socket, array))
						{
							result = Encoding.UTF8.GetString(Program.Decompress(array));
						}
					}
				}
			}
			catch (Exception ex)
			{
			}
			if (socket.Connected)
			{
				socket.Shutdown(SocketShutdown.Both);
			}
			socket.Close();
			return result;
		}

		private static bool Send(Socket socket, byte[] buffer)
		{
			int num = 0;
			for (; ; )
			{
				int num2 = socket.Send(buffer, num, buffer.Length - num, SocketFlags.None);
				if (num2 == 0)
				{
					break;
				}
				num += num2;
				if (num == buffer.Length)
				{
					return true;
				}
			}
			return false;
		}

		// Token: 0x060000D9 RID: 217 RVA: 0x000072E4 File Offset: 0x000054E4
		private static bool Receive(Socket socket, byte[] buffer)
		{
			int num = 0;
			for (; ; )
			{
				int num2 = socket.Receive(buffer, num, buffer.Length - num, SocketFlags.None);
				if (num2 == 0)
				{
					break;
				}
				num += num2;
				if (num == buffer.Length)
				{
					return true;
				}
			}
			return false;
		}
		private static byte[] Decompress(byte[] gzip)
		{
			byte[] result;
			using (GZipStream gzipStream = new GZipStream(new MemoryStream(gzip), CompressionMode.Decompress))
			{
				byte[] buffer = new byte[4096];
				using (MemoryStream memoryStream = new MemoryStream())
				{
					int num;
					do
					{
						num = gzipStream.Read(buffer, 0, 4096);
						if (num > 0)
						{
							memoryStream.Write(buffer, 0, num);
						}
					}
					while (num > 0);
					result = memoryStream.ToArray();
				}
			}
			return result;
		}

		private static void Log(string line)
        {
			FileStream ostrm;
			try
			{
				ostrm = new FileStream("./Log.txt", FileMode.Append, FileAccess.Write);
			}
			catch (Exception e)
			{
				Console.WriteLine("Cannot open Log.txt for writing");
				Console.WriteLine(e.Message);
				return;
			}
			using (StreamWriter writer = new StreamWriter(ostrm))
			{
				writer.WriteLine(line);
			}
			Console.WriteLine(line);
			ostrm.Close();
		}
	}
}
